<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta charset="UTF-8">
<title>DefCost 3.0.2</title>
<style>
:root{--bg:#f7f7f7;--fg:#333;--header:#e0e0e0;--btn:#007bff;--btnh:#0056b3;--add:#28a745;--addh:#218838;--border:#aaa;--alt:#f9f9f9;--panel:#fff;--toast:#007bff;--toastfg:#fff;--rowHover:#e9f1ff}
.dark-mode{--bg:#222;--fg:#eee;--header:#444;--btn:#0d6efd;--btnh:#0a58ca;--add:#198754;--addh:#157347;--border:#555;--alt:#2a2a2a;--panel:#333;--toast:#0d6efd;--toastfg:#fff;--rowHover:#383838}
body{font-family:sans-serif;margin:1rem;background:var(--bg);color:var(--fg);transition:.3s}
h1{margin:.2rem 0}p{margin:0 0 2rem}
#darkModeToggle{position:fixed;top:10px;right:10px;z-index:3000;background:var(--btn);color:#fff;border:none;padding:.5rem .75rem;border-radius:4px;cursor:pointer}
#darkModeToggle:hover{background:var(--btnh)}
#sheetTabs{border-bottom:1px solid var(--border);margin-bottom:1rem}
#sheetTabs button{background:none;border:none;padding:.5rem 1rem;margin-right:.5rem;cursor:pointer;font-size:1rem;color:var(--fg)}
#sheetTabs button.active{border-bottom:2px solid var(--btn);font-weight:bold}
.search-container{margin-bottom:1rem;padding:.5rem;background:var(--panel);border:1px solid var(--border);border-radius:4px;display:flex;flex-wrap:wrap;align-items:center;gap:.5rem}
.search-label{font-weight:bold}
.search-control{display:flex;align-items:center;gap:.5rem;flex:1 1 220px}
.search-input{padding:.4rem .5rem;border:1px solid var(--border);border-radius:4px;flex:1 1 auto;background:var(--panel);color:var(--fg)}
.search-cancel{display:none;padding:.35rem .75rem;border-radius:4px;border:1px solid var(--border);background:var(--header);color:var(--fg);cursor:pointer;font-weight:600;white-space:nowrap}
.search-cancel:hover{filter:brightness(.96)}
.search-cancel.visible{display:inline-flex}
.highlight{background:yellow}
table{border-collapse:collapse;width:100%}
thead th{position:sticky;top:0;background:var(--header);border:1px solid var(--border);padding:.5rem;text-align:center;z-index:2}
tbody td{border:1px solid var(--border);padding:.5rem}
tbody tr{background:var(--panel)}
tbody tr:hover{background:var(--rowHover)}
.add-button{background:var(--add);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;font-weight:bold;cursor:pointer}
.add-button:hover{background:var(--addh)}
.copied-cell{background:#c8e6c9!important;transition:.15s}
details{margin-bottom:1rem}
summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;border-radius:4px;background:var(--header);font-weight:bold}
summary::-webkit-details-marker{display:none}
summary:hover{background:var(--btn);color:#fff}
.dark-mode summary{color:#000}
.dark-mode summary:hover{color:#fff}
.cat-orange summary{background:#ffe9d6}.cat-orange summary:hover{background:#ffc999;color:#000}
.cat-blue summary{background:#d8ebff}.cat-blue summary:hover{background:#add6ff;color:#000}
.cat-brown summary{background:#f2e6d9}.cat-brown summary:hover{background:#e0cbb9;color:#000}
.cat-red summary{background:#ffdede}.cat-red summary:hover{background:#ffb7b7;color:#000}
.cat-yellow summary{background:#fff8d6}.cat-yellow summary:hover{background:#ffea9f;color:#000}
#quoteBuilderMain{margin-top:1.5rem;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.18);padding:1rem 1.25rem 1.5rem;display:flex;flex-direction:column;gap:1rem}
#quoteHeader{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:.75rem}
.quote-header-left{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
#quoteHeader #qbTitle{margin:0;font-size:1.55rem;font-weight:bold}
#quoteActions{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;justify-content:flex-end}
#quoteActions button{background:var(--btn);color:#fff;border:none;padding:.4rem .75rem;border-radius:6px;cursor:pointer;font-weight:600}
#quoteActions button:hover{background:var(--btnh)}
#catalogWindow{position:fixed;top:64px;right:32px;width:min(1100px,90vw);height:min(65vh,80vh);background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 24px 80px rgba(0,0,0,.35);display:flex;flex-direction:column;z-index:10000;overflow:hidden}
#catalogWindow.qb-full{top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;border-radius:0}
#catalogWindow.qb-docked{left:16px;right:16px;bottom:16px;width:auto;max-width:none;border-radius:12px 12px 0 0}
#catalogWindow.qb-floating{cursor:auto}
#catalogWindow.qb-docked #catalogTitlebar{cursor:default}
#catalogResizeHandle{position:absolute;width:18px;height:18px;right:0;bottom:0;cursor:se-resize;display:none}
#catalogResizeHandle::after{content:"";position:absolute;inset:4px;border-right:2px solid rgba(0,0,0,.2);border-bottom:2px solid rgba(0,0,0,.2);border-radius:2px}
.dark-mode #catalogResizeHandle::after{border-color:rgba(255,255,255,.25)}
#catalogWindow.qb-floating #catalogResizeHandle{display:block}
#catalogWindow.qb-full #catalogResizeHandle,#catalogWindow.qb-docked #catalogResizeHandle{display:none}
#catalogTitlebar{display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.5rem .75rem;background:var(--header);border-bottom:1px solid var(--border);cursor:move;user-select:none}
#catalogDots{display:flex;gap:.5rem}
#catalogDots button{width:12px;height:12px;border-radius:50%;border:0;cursor:pointer}
#catalogClose{background:#ff5f57}
#catalogMin{background:#ffbd2e}
#catalogZoom{background:#28c840}
.dark-mode #catalogClose,.dark-mode #catalogMin,.dark-mode #catalogZoom{box-shadow:inset 0 0 0 1px rgba(0,0,0,.2)}
#catalogTitle{flex:1;font-weight:bold}
#catalogBody{flex:1;overflow:auto;scrollbar-gutter:stable both-edges;padding:0 1rem 1rem}
#catalogDockIcon{position:fixed;left:16px;bottom:16px;display:none;border-radius:999px;padding:.5rem .8rem;background:var(--btn);color:#fff;border:none;cursor:pointer;z-index:10001}
#catalogDockIcon:hover{background:var(--btnh)}
.qb-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:10002;padding:1rem}
.qb-modal{background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.35);max-width:420px;width:100%;padding:1.25rem;display:flex;flex-direction:column;gap:1rem}
.qb-modal h4{margin:0;font-size:1.1rem}
.qb-modal p{margin:0;font-size:.95rem;line-height:1.4}
.qb-modal-buttons{display:flex;gap:.5rem;justify-content:flex-end;flex-wrap:wrap}
.qb-modal-buttons button{background:var(--btn);color:#fff;border:none;padding:.4rem .75rem;border-radius:6px;cursor:pointer}
.qb-modal-buttons button:hover{background:var(--btnh)}
.qb-modal-buttons .danger{background:#dc3545}
.qb-modal-buttons .danger:hover{background:#bb2d3b}
.qb-modal-buttons .neutral{background:var(--header);color:var(--fg)}
.qb-modal-buttons .neutral:hover{filter:brightness(.95)}
#basketContainer{display:flex;flex-direction:column;min-height:100%;gap:0}
#basketContent{display:flex;flex-direction:column;gap:1rem}
.basket-table-area{flex:1 1 auto;min-width:0}
.grand-totals-wrapper{display:none;justify-content:flex-end;margin-top:1rem}

#grandTotals{margin:0;padding:0;border:0;border-radius:8px;background:transparent;display:none;font-weight:600;width:min(320px,100%);max-width:340px}
#sectionTabsBar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;padding:.45rem .65rem;min-height:48px;background:var(--header);border:1px solid var(--border);border-bottom:0;border-radius:8px 8px 0 0}
#sectionTabs{display:flex;flex-wrap:wrap;gap:.25rem}
.section-tab{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .6rem;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--fg);cursor:pointer;transition:.2s}
.section-tab.active{background:var(--btn);color:#fff;border-color:var(--btn)}
.section-tab button{background:none;border:none;color:inherit;cursor:pointer;padding:0;font-size:.85rem;line-height:1}
.section-tab button:hover{opacity:.85}
#sectionTabs .section-name{max-width:160px;display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#addSectionBtn{background:var(--add);color:#fff;border:none;padding:.35rem .7rem;border-radius:6px;font-weight:bold;cursor:pointer}
#addSectionBtn:hover{background:var(--addh)}
#basketTable{table-layout:fixed;background:var(--panel)}
#basketContent{background:var(--panel)}
#basketTable th,#basketTable td{border:1px solid var(--border);padding:.24rem .28rem;box-sizing:border-box;vertical-align:middle;overflow:hidden}
#basketContainer thead th{position:static}
#basketTable tbody tr:hover{background:var(--rowHover)}
.sort-handle{cursor:move;user-select:none;text-align:left;font-size:1.1rem;min-width:2em}
.qty-input{width:48px;text-align:center;height:1.6em}
.remove-btn{color:red;font-weight:bold;cursor:pointer}
.sub-row td{background:var(--alt);font-size:.95em}
.sub-row .item-input{min-height:1.6em}
.sub-item-cell{position:relative;padding-left:0}
.sub-row td:first-child{position:relative}
.sub-row td:first-child::before{content:"↳";position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.6;font-weight:bold}
.sub-controls{display:inline-flex;gap:.25rem;margin-right:.25rem;vertical-align:middle}
.subbtn{padding:.1rem .35rem;border:1px solid var(--border);background:var(--panel);cursor:pointer;border-radius:4px}
.dark-mode .subbtn{background:#fff;color:#000;border-color:#888}
.dark-mode .subbtn:hover{filter:brightness(.95)}
.subbtn.active{background:var(--btn);color:#fff;border-color:var(--btn)}
.dark-mode .subbtn.active{background:var(--btn);color:#fff;border-color:var(--btn)}
#toast{margin-left:1rem;background:var(--toast);color:var(--toastfg);padding:.3rem .6rem;border-radius:4px;opacity:0;transition:.3s}
#toast.show{opacity:1}
.import-summary-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1.5rem;background:rgba(0,0,0,.4);z-index:20000;backdrop-filter:blur(1px);}
.import-summary-card{width:100%;max-width:28rem;border-radius:0.75rem;padding:1.5rem;background:#fff;color:#1f2937;text-align:center;box-shadow:0 25px 70px rgba(15,23,42,.35);}
.dark-mode .import-summary-card{background:#18181b;color:#e4e4e7;box-shadow:0 25px 70px rgba(0,0,0,.55);}
.import-summary-title{font-size:1.75rem;font-weight:700;margin:0 0 .5rem;color:#002d72;}
.dark-mode .import-summary-title{color:#60a5fa;}
.import-summary-subtitle{margin:0 0 1.25rem;font-size:1rem;color:#52525b;}
.dark-mode .import-summary-subtitle{color:#a1a1aa;}
.import-summary-table{width:100%;border-collapse:separate;border-spacing:0;margin-bottom:1.25rem;font-size:1rem;}
.import-summary-table tr{border-bottom:1px solid rgba(15,23,42,.08);}
.dark-mode .import-summary-table tr{border-bottom:1px solid rgba(148,163,184,.25);}
.import-summary-table tr:last-child{border-bottom:none;}
.import-summary-table td{padding:.55rem .75rem;font-weight:600;text-align:left;}
.import-summary-table td:last-child{text-align:right;font-variant-numeric:tabular-nums;}
.import-summary-table tr:nth-child(even){background:rgba(244,244,245,.7);}
.dark-mode .import-summary-table tr:nth-child(even){background:rgba(39,39,42,.75);}
.import-summary-divider{height:1px;background:rgba(15,23,42,.12);margin:1rem 0;}
.dark-mode .import-summary-divider{background:rgba(148,163,184,.35);}
.import-summary-actions{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center;}
.import-summary-view-btn,.import-summary-undo-btn{border:none;border-radius:9999px;padding:.6rem 1.65rem;font-weight:600;cursor:pointer;transition:.2s ease;}
.import-summary-view-btn{background:#0b64d0;color:#fff;}
.import-summary-view-btn:hover{background:#084fa5;}
.dark-mode .import-summary-view-btn{background:#2563eb;}
.dark-mode .import-summary-view-btn:hover{background:#1d4ed8;}
.import-summary-undo-btn{background:#e4e4e7;color:#27272a;}
.import-summary-undo-btn:hover{filter:brightness(.95);}
.dark-mode .import-summary-undo-btn{background:#3f3f46;color:#f4f4f5;}
.dark-mode .import-summary-undo-btn:hover{filter:brightness(1.05);}
.editable{background:#fff;border:1px solid var(--border);padding:.28rem .4rem;border-radius:6px;width:100%;box-sizing:border-box;display:block;margin:0}
.item-input{display:block;width:100%;min-height:1.6em;max-height:8em;resize:vertical;overflow:auto;white-space:pre-wrap;line-height:1.24}
.price-input{width:100%;min-height:1.6em;max-width:none;text-align:right;box-sizing:border-box;margin:0}
#basketTable th:nth-child(1),#basketTable td:nth-child(1){width:36px}
#basketTable th:nth-child(2),#basketTable td:nth-child(2){width:200px}
#basketTable th:nth-child(4),#basketTable td:nth-child(4){width:120px}
#basketTable th:nth-child(5),#basketTable td:nth-child(5){width:110px}
#basketTable th:nth-child(6),#basketTable td:nth-child(6){width:140px}
#basketTable th:nth-child(7),#basketTable td:nth-child(7){width:50px}
#basketTable col#col-item,#basketHead col#col-item{width:auto}
.grand-totals-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--panel)}
.grand-totals-table th,.grand-totals-table td{padding:.4rem .5rem;border-bottom:1px solid var(--border);text-align:left;font-weight:600}
.grand-totals-table tr:last-child th,.grand-totals-table tr:last-child td{border-bottom:0}
.grand-totals-table th{font-weight:700;white-space:nowrap}
.grand-totals-table td{font-weight:600}
.grand-totals-table tr th:first-child,.grand-totals-table tr td:first-child{border-right:1px solid var(--border)}
.grand-totals-table .totals-value{text-align:right;font-variant-numeric:tabular-nums}
.grand-totals-table .grand-totals-input{display:flex;align-items:center;gap:.35rem}
.grand-totals-table .grand-totals-input input{width:100%;padding:.32rem .4rem;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--fg)}
.grand-totals-table .grand-totals-input span{opacity:.75}
.section-notes-cell{padding:0!important}
.section-notes-wrapper{display:flex;flex-direction:column;gap:.4rem;padding:.45rem .65rem}
.section-notes-wrapper label{font-weight:600}
.section-notes-wrapper textarea{width:100%;min-height:72px;padding:.32rem .4rem;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--fg);resize:vertical;font-family:inherit;font-size:1rem;line-height:1.28}
.dark-mode .section-notes-wrapper textarea{background:#2c2c2c;color:#fff;border-color:#555}
.qty-controls{display:flex;align-items:center;gap:.25rem}
.qty-controls button{padding:.15rem .4rem;line-height:1}
.section-cell{vertical-align:middle}
.section-select{width:100%;padding:.28rem .35rem;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--fg);font-size:.9rem;box-sizing:border-box}
.dark-mode .section-select{background:#444;color:#fff;border-color:#666}
.section-readonly{display:block;padding:.28rem .35rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#basketSticky{position:sticky;top:0;z-index:4;background:var(--panel);box-shadow:0 2px 4px rgba(0,0,0,.06);padding:1rem 0 0;border-top:1px solid var(--border)}
#basketStickyHead{background:var(--panel)}
#basketStickyHead table{width:100%;table-layout:fixed;border-collapse:collapse}
#basketStickyHead thead th{background:var(--header);border:1px solid var(--border);padding:.28rem;text-align:center}
#basketTable thead{display:none}
input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}
</style>
</head>
<body>
<h1>DefCost 3.0.2</h1>
<button id="darkModeToggle">Toggle Dark Mode</button>
<div id="quoteBuilderMain" aria-label="Quote Builder" role="region">
  <div id="quoteHeader">
    <div class="quote-header-left">
      <h2 id="qbTitle">Quote Builder</h2>
      <span id="toast"></span>
    </div>
    <div id="quoteActions">
      <button id="clearQuoteBtn" type="button" aria-label="Delete quote">Delete quote</button>
      <button id="addCustomBtn" type="button">Add custom line</button>
      <button id="addSectionBtn" type="button">+ Section</button>
      <button id="importCsvBtn" type="button">Import CSV</button>
      <button id="exportCsvBtn" type="button">Export quote CSV</button>
      <input id="importCsvInput" type="file" accept=".csv" style="display:none">
    </div>
  </div>
  <div id="sectionTabsBar">
    <div id="sectionTabs"></div>
  </div>
  <div id="basketContainer">
    <div id="basketSticky">
      <div id="basketStickyHead">
        <table id="basketHead">
          <colgroup>
            <col style="width:36px">
            <col style="width:200px">
            <col id="col-item">
            <col style="width:120px">
            <col style="width:110px">
            <col style="width:140px">
            <col style="width:50px">
          </colgroup>
          <thead><tr>
            <th class="sort-handle">≡</th><th>Section</th><th>Item</th><th>Quantity</th>
            <th>Price</th>
            <th>Line Total</th><th></th>
          </tr></thead>
        </table>
      </div>
    </div>
    <div id="basketContent">
      <div class="basket-table-area">
      <table id="basketTable">
        <colgroup>
          <col style="width:36px">
          <col style="width:200px">
          <col id="col-item">
          <col style="width:120px">
          <col style="width:110px">
          <col style="width:140px">
          <col style="width:50px">
        </colgroup>
          <thead><tr>
            <th class="sort-handle">≡</th><th>Section</th><th>Item</th><th>Quantity</th>
            <th>Price</th>
            <th>Line Total</th><th></th>
          </tr></thead>
        <tbody></tbody><tfoot></tfoot>
      </table>
      </div>
    </div>
  </div>
  <div class="grand-totals-wrapper">
    <aside id="grandTotals" aria-live="polite"></aside>
  </div>
</div>
<div id="catalogWindow" aria-label="Catalogue window" role="dialog" aria-modal="false">
  <div id="catalogTitlebar">
    <div id="catalogDots">
      <button id="catalogClose" aria-label="Hide catalogue" title="Hide catalogue"></button>
      <button id="catalogMin" aria-label="Dock window" title="Dock window"></button>
      <button id="catalogZoom" aria-label="Full screen" title="Full screen"></button>
    </div>
    <div id="catalogTitle">Catalogue</div>
  </div>
  <div id="catalogBody">
    <div id="sheetTabs"></div>
    <div id="status" style="margin:.5rem 0;font-size:.9rem"></div>
    <div id="manualLoad" style="display:none;margin:.5rem 0"><label class="search-label">Load workbook:</label><input type="file" id="xlsxPicker" accept=".xlsx"></div>
    <div id="sheetContainer"></div>
  </div>
  <div id="catalogResizeHandle" aria-hidden="true"></div>
</div>
<button id="catalogDockIcon" title="Open catalogue" aria-label="Open catalogue">Catalogue</button>
<script src="xlsx.full.min.js"></script>
<script>if(!window.XLSX){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js';s.setAttribute('data-sheetjs','1');document.head.appendChild(s);}</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script type="module" src="./js/main.js"></script>
<script>
(function(){try{
  if(!window.__wd_main_ok__){
    var status=document.getElementById('status');
    if(status){status.innerHTML='<span style="color:#b00">Main script did not finish loading. Check Console for the first error above.</span>';}
    if(window.XLSX){
      fetch('./Defender%20Price%20List.xlsx',{cache:'no-store'}).then(function(r){return r.arrayBuffer();}).then(function(buf){
        var wb=XLSX.read(buf,{type:'array'});var names=Object.keys(wb.Sheets||{});if(!names.length)return;
        var html=XLSX.utils.sheet_to_html(wb.Sheets[names[0]]);
        document.getElementById('sheetContainer').innerHTML=html;
      }).catch(function(){});
    }
  }
}catch(e){} })();
</script>
</body>
</html>
